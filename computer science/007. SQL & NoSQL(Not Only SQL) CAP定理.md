# SQL
ãƒ»SQL ï¼ RDB ï¼B+tree<br>
ãƒ»Oracle/MySQL/PostgreSQLã®INDEXã¯B+treeã‚’æ¡ç”¨ã€‚<br>
ãƒ»B+treeãŒå¾—æ„ã¨ã™ã‚‹æ¤œç´¢ã‚’å®Ÿç¾ã—ãŸã„å ´åˆ or ACIDã‚’å®Ÿç¾ã—ãŸã„å ´åˆã¯ã€RDB(SQL)ã‚’ä½¿ãˆã°OKğŸ‘

ç‰¹å¾´<br>
ãƒ»ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä¸€æ„ã«ç‰¹å®šã§ãã‚‹PK<br>
ãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«é–“ã‚’JOINã—ã¦å–å¾—<br>
ãƒ»ACID

## ACID
Relational database is ACID compliant.

### Atomicity
ãƒ»Atomï¼åŸå­ã€‚Splitã§ããªã„ã€‚<br>
ãƒ»transactions is ALL or NOTHING. A transaction canâ€™t be splited.

### Consistency
ãƒ¬ã‚³ãƒ¼ãƒ‰æ¶ˆã™ â–¶ï¸ ãã‚Œã‚’å¤–éƒ¨ã‚­ãƒ¼ã¨ã—ã¦å‚ç…§ã—ã¦ã„ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ¶ˆã™ãªã‚Šã—ã¦ã€ä¸€è²«æ€§ã‚’ä¿ã¤ã€‚

### Isolation
- When multiple transactions runs concurrently, want them NOT to have side effects for each other.
- IsolationãŒä¿ãŸã‚Œãªã‹ã£ãŸã‚‰ã€Dirty Readãƒ»Phantom Readãƒ»Repeatable Readç™ºç”Ÿ

### Durability
Thatâ€™s why we use disks where persistent<br>
â—‹ Persistent<br>
â–³ Slower than memory


# Not Only SQL
ãƒ»not have relations<br>
ãƒ»canâ€™t join <br>
ãƒ»CAPï¼ˆACIDã‚’æº€ãŸã™å ´åˆã‚‚ã‚ã‚‹ï¼‰
```
â‘  Key-value store
â‘¡ Document store
â‘¢ Wide-column DB
â‘£ Graph-based DB
```

## â‘  Key-value store
ãƒ»no relation, just key-value<br>
ãƒ»id must be primary key<br>
â—‹ Faster because of **using RAM** not disks<br>
ğŸ‘‰Use-caseã¯ã€PrimaryDB(SQL)ã¨ä¸€ç·’ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç½®ãå ´ã—ã¨ã¦NoSQL

### Popular key-value store
ãƒ»Redis<br>
ãƒ»Memcached

## â‘¡ Document store
a kind of step-up from key-value stores

**Document = JSON object**<br>
ãƒ»multiple keys<br>
ãƒ»nested<br>
ãƒ»value can be object and array<br>
ãƒ»**no need to define schema** like tbl definitions

### Popular Document Store
ãƒ»AWS DynamoDB<br>
ãƒ»MongoDB

â€»â†“ãŸã ã®æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã¯ãªã„ã€‚<br>
ãƒ»ElasticSearch<br>
ãƒ»OpenSearch

### RDBã§ã¯ãªãã€DocumentStoreã‚’ä½¿ã†ç†ç”±ã¯ï¼Ÿ
ãƒ»ACIDã§ã¯ãªã„ -> ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šï¼ŸShardingï¼ŸCAPå®šç†<br>
ãƒ»ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã‚‰ã¸ã‚“


### DocumentDBã€æ·±å €ã‚Š
ãƒ»æŸ”è»Ÿã«ã‚¯ã‚¨ãƒª/æ¤œç´¢ ã™ã‚‹ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢<br>
ãƒ»ï¼‘ã¤ã®JSONã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ ï¼ Document<br>
ãƒ»ãã‚Œãã‚Œã®Documentã¯ç•°ãªã‚‹å±æ€§ã‚’ã‚‚ã£ã¦ã¦ã„ã„=**ã‚¹ã‚­ãƒ¼ãƒã®å®šç¾©ä¸è¦**

### Use case
ã‚«ã‚¿ãƒ­ã‚°<br>
ãƒ»å•†å“ã¨ã„ã†ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒã‚ã‚‹å ´åˆã€**å„å•†å“ã”ã¨ã«ã—ã‹ã‚‚ãŸãªã„å¤§é‡ã®å±æ€§**ã‚ã‚‹ã€‚<br>
ãƒ»RDBã ã¨å…¨ã¦ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã«èµ·ã“ã™å¿…è¦ãŒã‚ã‚‹ãŒã€DocumentDBã¯ä¸è¦ã€‚

## â‘¢ Wide-column DB
ãƒ»Cassandra<br>
ãƒ»Google big table

## â‘£ Graph-based DB
This is all relations actuallyâ€¦<br>
â˜…SNSã§â€èª°ã‚’ãƒ•ã‚©ãƒ­ãƒ¼ã—ã¦ã‚‹ã®ã‹â€ã‚’RDBã§ç®¡ç†ã™ã‚‹ã®ã¯å¤§å¤‰â€¦<br>
This is NoSQL database by somehow keeps the feature of relations part.

# NoSQL uses Sharding (not Replication) ... means "Eventually Consistent"
Many many read and writes to database.... what do we do?

**o1. Vertical Scaling**

ã€€â†“ not enough by vertical scaling

**o2. Horizontal Scaling with "Replication"**

ã€€â†“ not enough by replication because of MASSIVE data<br>
ã€€when searching the amount of data **in a single machine** takes many time

**o3. Sharding**<br>
ãƒ»We've taken our **individual** database and **broken it into smaller pieces aka "shards"**.<br>
ãƒ»When a user reads and writes, they will go to individual shards.
![](https://storage.googleapis.com/zenn-user-upload/7c9ed4b67d6d-20230427.png)

Benefits of shards<br>
âœ…Balance more traffics.<br>
âœ…Queries go faster because each database has the half data.

## How to distribute data into shards?
Take one item "**Shard key**" which is used to decide how to split the data up.
### 1. Range-based shard key
For ex, we have gender column which contains MALE or FEMALE.<br>
If we take gender column as Range-based shard key, <br>
ã€€Shard 1 have All MAKE data.<br>
ã€€Shard 2 have All FEMALE data.
 
 ### 2. Hash-based shard key
 This is a use-case for **consistent hashing**.
 
 ## Why difficult to use Sharding? -> keep consistent relation /:
 When we have two related tables, we have to keep consistent both of them.

## SQL databases(MySQL/PostgreSQL) not have sharding by default...
It make sense because SQL database is naturally not meant to be distributed in sharding way. <br>
When doing sharding, **we lose the consistency the we get from ACID**.

## NoSQL database have sharding by default!!!
ãƒ»**NoSQL databases are natually meant to be sharded.**<br>
ãƒ»Our data is **non-relational**.<br>
ãƒ»The data doesn't even have to be consistent from the notes.<br>
ãƒ»They will be **eventually consistent.**


# Cap Theorem/CAPå®šç†

# å¼•ç”¨

å¤§å‰æã€‚CAPå®šç†ã¯ã€Node/ã‚µãƒ¼ãƒã‚’ç•°ãªã‚‹ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«é…ç½®ã—ãŸã¨ãã«ã€å–æ¨é¸æŠ(Tradeoff)ã™ã‚‹è€ƒãˆæ–¹ã€‚

> CAPã‚’ç†è§£ã™ã‚‹æœ€ã‚‚ç°¡å˜ãªæ–¹æ³•ã¯åˆ†å‰²ã®ä¸¡å´ã«ã²ã¨ã¤ãšã¤ãƒãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã‚’è€ƒãˆã‚‹ã“ã¨ã§ã™ã€‚ç‰‡æ–¹ã®ãƒãƒ¼ãƒ‰ã ã‘çŠ¶æ…‹ã‚’æ›´æ–°ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã¨ã€2ã¤ã®ãƒãƒ¼ãƒ‰ã«ä¸€è²«æ€§ãŒãªããªã‚Šã¾ã™ã€‚ã¤ã¾ã‚Šã€CãŒå¤±ã‚ã‚Œã¾ã™ã€‚

>ä¸€è²«æ€§ã‚’ç¶­æŒã—ã‚ˆã†ã¨ã™ã‚Œã°ã€ä¸€æ–¹ã®ãƒãƒ¼ãƒ‰ã¯åˆ©ç”¨ã§ããªã„çŠ¶æ…‹ã§ã‚ã‚‹ã‹ã®ã‚ˆã†ã«å‹•ä½œã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚ã“ã®å ´åˆã€AãŒå¤±ã‚ã‚Œã¾ã™ã€‚**ä¸€è²«æ€§ã¨å¯ç”¨æ€§ãŒç¶­æŒã§ãã‚‹ã®ã¯ã€ãµãŸã¤ã®ãƒãƒ¼ãƒ‰ãŒé€šä¿¡ã§ãã‚‹å ´åˆã ã‘ã§ã™ã€‚ã“ã®å ´åˆã€PãŒå¤±ã‚ã‚Œã¾ã™**ã€‚ä¸€èˆ¬çš„ã«ã¯ã€åºƒåŸŸã‚·ã‚¹ãƒ†ãƒ ã®å ´åˆã€è¨­è¨ˆè€…ã¯Pã‚’å¤±ãˆã¾ã›ã‚“ã®ã§ã€Cã¨Aã®é–“ã§é›£ã—ã„é¸æŠã‚’å¼·ã„ã‚‰ã‚Œã¾ã™ã€‚

>ã‚ã‚‹æ„å‘³ã§ã¯NoSQLã®å‹ƒèˆˆã¯å¯ç”¨æ€§ã‚’ç¬¬ä¸€å„ªå…ˆã«ã€ä¸€è²«æ€§ã‚’äºŒã®æ¬¡ã«ã™ã‚‹é¸æŠè‚¢ã‚’ç”Ÿã¿å‡ºã—ã¦ã„ã‚‹ã¨è¨€ãˆã¾ã™ã€‚ACIDå±æ€§ã«å¾“ã†ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆåŸå­æ€§ã€ä¸€è²«æ€§ã€ç‹¬ç«‹æ€§ã€è€ä¹…æ€§ï¼‰ã¯ã“ã®åå¯¾ã§ã™ã€‚"ACIDã€BASEã€CAP"ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã“ã®é•ã„ã‚’è©³è¿°ã—ã¾ã™ã€‚

> **ä¸€èˆ¬ã«ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã¯ã€ä¸€è²«æ€§ï¼ˆCï¼‰ã¨å¯ç”¨æ€§ï¼ˆAï¼‰ã‚’ã§ãã‚‹ã ã‘ä¿è¨¼ã™ã‚‹ä»£ã‚ã‚Šã«ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†æ–­ã¸ã®è€æ€§ï¼ˆPï¼‰ã‚’çŠ ç‰²ã«ã—ã¦ã„ã¾ã™**ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒé€”ä¸­ã§åˆ‡ã‚ŒãŸã‚Šå¤§ããé…å»¶ã—ãŸå ´åˆã€å‹•ä½œãŒä¿è¨¼ã•ã‚Œãªããªã£ã¦ã—ã¾ã†ã‚ã‘ã§ã™ã€‚

âœ…RDBã¯ã€ä¸€è²«æ€§ã€å¸¸ã«NWéšœå®³ãªã—(Partitionè€æ€§ã‚¼ãƒ­)ã€‘ã¨å¯ç”¨æ€§ã€NWè¶Šã—ã®ä¸¡æ–¹ã®NodeãŒå¿…è¦ã€‘ãªã®ã§ã€Leaderã¨Followerã¯å¸¸ã«åŒæœŸã—ã¦ãŸã„ã€‚ã™ãªã‚ã¡ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†æ–­ã•ã‚Œã¦ã—ã¾ã£ãŸã‚‰çµ‚ã‚ã‚‹ã€‚

>ä¸€æ–¹ã§NoSQLã§ã¯ä¸€è²«æ€§ï¼ˆCï¼‰ã‚ˆã‚Šã‚‚å¯ç”¨æ€§ï¼ˆAï¼‰ã¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†æ–­ã¸ã®è€æ€§ï¼ˆPï¼‰ã‚’å„ªå…ˆã•ã›ã‚‹ã‚‚ã®ãŒå¤šãã€åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã§ã®å‹•ä½œã«å‘ã„ã¦ã„ã‚‹ã¨èª¬æ˜ã•ã‚Œã¾ã™ã€‚ã“ã®ã‚ˆã†ã«NoSQLã®èª¬æ˜ã«ã“ã®CAPå®šç†ãŒã—ã°ã—ã°å¼•ç”¨ã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã€NoSQLã®æ™®åŠã¨ã¨ã‚‚ã«CAPå®šç†ã‚‚åºƒãçŸ¥ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

âœ…NoSQLã¯ã€ä¸€è²«æ€§ãŒãªãã¦ã‚‚ã‚ã‚‹ç¨‹åº¦OKã¿ãŸã„ãªæ„Ÿã˜ã ã‹ã‚‰ã€ãƒãƒƒãƒˆãƒ¼ãƒ¯ãƒ¼ã‚¯åˆ†æ–­ã•ã‚Œã¦ã‚‚ã€ŒãŠkã€‚ãŠã‚Œã‚‰ãã‚Œãã‚Œã§å‡¦ç†ç¶™ç¶šã—ã¦ã‚‹ã‚ã€ã¿ãŸã„ãªæ„Ÿã˜ã§å•é¡Œãªã„æ„Ÿã˜ã¨ãªã‚‹ã€‚

https://www.publickey1.jp/blog/13/capcap32.html

# CAP

âœ”ï¸åˆ†æ•£ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‚’ãƒ‡ã‚¶ã‚¤ãƒ³ã™ã‚‹ã¨ãã«**ä½•ãŒTradeOffã¨ãªã‚‹ã®ã‹**ã‚’ç†è§£ã™ã‚‹ãŸã‚ã®å®šç†ã€‚

Consistency<br>
Availability<br>
Partition Tolerance

ãƒ»P is guaranteed to be chosen. (**åˆ¥ã€…ã®Networkã«ã‚µãƒ¼ãƒãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹å‰æ**)<br>
ãƒ»**We are allowed to choose either of C/A.**<br>

## Partition Tolerant
ãƒ»Partition = Network partitioned<br>
ã€€- Leaderã¨FollowerãŒåˆ¥NWã«ã‚ã‚‹ã€‚<br>
ã€€- Leaderã¯å®šæœŸçš„ã«Followerã¨åŒæœŸ

ãƒ»Partition tolerant<br>
ã€€- åˆ¥NW(partition)ã«ã‚ã‚‹Leaderã«æ¥ç¶šã§ããªããªã£ã¦ã‚‚ã€å¤§ä¸ˆå¤«ãªã“ã¨ã€‚

## Consistency 
ãƒ»æœ€æ–°ãƒ‡ãƒ¼ã‚¿ãŒåŒæœŸã•ã‚Œã¦ãªã„ãƒ¬ãƒ—ãƒªã‚«ã«å¯¾ã—ã¦èª­ã¿è¾¼ã¿å‡¦ç†ã‚’ã•ã›ãªã„ã“ã¨<br>
ãƒ»Data consistency between the replicated data(nodes)<br>
ãƒ»Leaderã¨åŒæœŸã—ãªã„ã¨data consistentã§ãªã„<br>
â€» different from â€œacid consistentâ€ (Single serverå†…ã§ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆãŸæ™‚ã®å¤–éƒ¨åˆ¶ç´„ã¨ã‹ã®è©±)

## Availability 
ãƒ»åŒæœŸã•ã‚Œã¦ãªãã¦ã‚‚å¯ç”¨æ€§ã‚’ç¢ºä¿ã™ã‚‹ãŸã‚ã«Followerã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã€‚

âœ…Consistencyã¨Availabiltyã©ã£ã¡ã‚’å–ã‚‹ã‹ï¼Ÿã¨ã„ã†è©±ãªã®ã§ã€CP or AP ã¨è¨€ã‚ã‚Œã¦ã„ã‚‹ã€‚

We have to make a strong consideration between consistency and availability.

åˆ¥NWãŒå‚ç…§ã§ããªããªã£ãŸã¨ãã«<br>
Cã‚’ã¨ã‚‹ â–¶ï¸ æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ã‚‚ã¤Leaderã ã‘ç¨¼åƒ<br>
Aã‚’ã¨ã‚‹ â–¶ï¸ å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’ã‚‚ã¤Replicaã‚‚ç¨¼åƒ

ã€€â†‘ã‚·ã‚¹ãƒ†ãƒ çš„ã«ã©ã£ã¡ã®æ–¹é‡ã«ã™ã‚‹ã‹ï¼Ÿ

ã¨ã„ã†è©±ã ã‹ã‚‰ã€å‰æã®
ãƒ»Leader<br>
ãƒ»åˆ¥NWã«ã‚ã‚‹(Partitioned)ReplicaãŸã¡<br>
ã®ã“ã¨ã‚’è©±ã—ã¦ã„ã‚‹ã®ãŒå¤§äº‹ã ãªã€‚

# PACELC
PAC = CAP
Given P(partition),
choose A or C,

Else (åŒã˜NW/Partitionã«ã‚ã‚‹å ´åˆ)
â€»NW/Partition toleranceã‚’æ°—ã«ã—ãªã„ç’°å¢ƒã§
favor Latency or Consistency ã©ã£ã¡ã‚’ã¨ã‚‹ï¼Ÿ

Want lower latency
â–¶ï¸Read replica asap
Want consistency
â–¶ï¸Wait for replication a few second

åŒã˜NWå†…ã§ã‚‚Followerã¸ã®ãƒ‡ãƒ¼ã‚¿åŒæœŸã¯ã‹ã‹ã‚‹


