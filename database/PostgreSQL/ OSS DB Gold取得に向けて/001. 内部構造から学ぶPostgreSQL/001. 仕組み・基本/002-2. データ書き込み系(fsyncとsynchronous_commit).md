# Dirtyページ の書き込み
✅↓いずれかのトリガーで、Dirtyページの書き込みが行われる。
- チェックポイント関連
  - `checkpoint_timeout`（時間ベース）-> 定期的にcheckpoint発行！
  - `max_wal_size`（サイズベース）-> 上限に達するとcheckpoint発行！
- バックグラウンドライタ関連
  - `bgwriter_delay`

# WALファイル の書き込み
## fsyncパラメータ
### OSにおけるfsync
- UNIX系OSには`fsync()`というシステムコールがある。
- これは「指定したファイルに対する書き込みを、OSキャッシュだけでなく実際のディスクにも反映させろ」 という命令です。
- 通常、ファイルに書き込むと一旦 OS のページキャッシュに溜まり、物理ディスクに書かれるのは後で（遅延書き込み）。
- `fsync()`を呼ぶことで、その遅延を待たずにディスクに確実に書き込みます。

### PostgreSQLにおけるfsync
- ↓のような「ディスクに対する書き込み処理」において、↑の`fsync`を有効にさせる。
- 🔴**WAL書き込みだけではなく、Dirtyバッファ書き込みにも適用される設定**🔴
  - COMMIT時にWALファイルをフラッシュする
  - `checkpointer`によるDirtyバッファをフラッシュする
- `fsync: false`にしても「待たない/保証しない」だけで、書き込み処理自体は行う✅

<br>

## synchronous_commitパラメータ（コミットの""完了""基準）
COMMIT完了の基準がこのパラメータ設定値で変わる。
- `off`だと
  - 「COMMIT完了」
  - 「WALログのfsync完了」🔴※COMMIT完了した後にfsync!!!
- `local`だと
  - 「WALログのfsync完了」
  - 「COMMIT完了」
- `remote_write`だと
  - 「WALログをローカルディスクにfsync完了」
  - 「リモートサーバへ送信完了」
  - 「COMMIT完了」
- `on`だと
  - 「WALログをローカルディスクにfsync完了」
  - 「リモートサーバへ送信完了」
  - 「リモートサーバのローカルディスクにてfsync完了」
  - 「COMMIT完了」

✅fsync=off にすると synchronous_commit の意味がほぼなくなる。<br>
✅fsync=on かつ synchronous_commit=on が最も安全（その分遅い）。<br>

## commit_delay, commit_siblingsパラメータ（コミット/WALフラッシュを遅延させる）
👉狙いは「TXによるWALファイルへの書き込みをまとめることによる効率化」である。<br>
✅対象となるTXは「更新のあるトランザクションのみ」です。SELECT系のTXは関係なし！<br>
<img width="700px" src="https://github.com/user-attachments/assets/277d5495-f1b8-4e7e-bc1b-f9127fb02107" />


