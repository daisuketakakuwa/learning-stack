オンライン＝「DB稼働したまま」
オフライン＝「DB止めた状態で」
オンラインバックアップ＝「DB稼働中にバックアップ取得」
オフラインバックアップ＝「DBを停止してからバックアップ取得」

物理バックアップ：データファイルそのものをコピーする方法。

### サマリ
- 論理
  - pg_dump（特定のデータベースやテーブル、スキーマのバックアップが必要な場合。）
  - pg_dumpall（全データベースとグローバル設定のバックアップが必要な場合。）
- 物理
  - pg_basebackup（ラスタ全体をそのままバックアップし、災害復旧やレプリケーションセットアップに利用する場合。

- オフライン×物理バックアップ＝ファイルをそのままコピー
- オンライン×物理バックアップ＝`pg_basebackup`でファイルコピー（**一貫性を保つために**）
- オンライン×論理バックアップ＝`pg_dump`/`pg_dumpall`コマンドで実現

✅`pg_basebackup`コマンドは、オンライン中に物理バックアップしたいとき専用</br>
✅オンライン×物理バックアップは、稼動中にバックアップ取得するのでその間にも反映された更新分=WALログをバックアップに組み込んであげる必要がある＝pg_basebackupコマンドの-Xオプションを利用＝pg_backbackupコマンドの-Xオプションは、バックアップ時に一時的に「archive_mode = on」を実現してくれるもの

![image](https://github.com/user-attachments/assets/1aa44140-1b64-493b-8264-78ed5238bcf8)

### 論理バックアップ
- テキスト（SQL）形式なので、PostgreSQLバージョンの互換性を気にする必要なし👉
- `pg_dump`か`pg_dumpall`でテキスト（SQL）に出力し、
#### pg_dumpコマンド方式
```
pg_dump -U username -d database_name -f backup.sql
```
- 単一のデータベースのみ対象
- データを別の形式（SQLやCSV）で抽出する方法。
- グローバルデータは抽出しない。

#### pg_dumpallコマンド
```
pg_dumpall -U username -f backup_all.sql
```
- PostgreSQLインスタンス全体（すべてのデータベースとグローバル設定）をバックアップ。
- ユーザーアカウントやロールなどのデータベース外のグローバル情報も含まれる。
- テキスト形式のみで、部分的な復元がやや不便。

### 物理バックアップ
- データベースサーバと同じバージョンでしか動作しない（異なるバージョン間での移行には不向き）。
#### pg_basebackupコマンド
```
pg_basebackup -U replication_user -D /backup/directory -Fp -Xs -P
```
- データベースのデータディレクトリ全体をコピー。
- PostgreSQLクラスタ全体をそのままバックアップするため、データベースの状態が完全に保存される。
- レプリケーションや災害復旧のためのバックアップに適している。
- **WALファイルもバックアップされる**ため、クラッシュリカバリや特定の時点への復元が可能。

