## VACUUMで集める統計情報（pg_statistic）
<img width="700px" height="962" alt="image" src="https://github.com/user-attachments/assets/ac4e3627-32fa-4da6-be5b-b130139fb309" />

## EXPLAIN(実行計画)のもととなる統計情報(pg_statistic/pg_stats)について
- EXPLAIN(実行計画)のもととなる統計情報について
  - pg_stats と pg_statistic の違い
    - 元テーブル(pg_statistic)をもとに、User向けに分かりやすくしてるのがpg_statsビュー
    - 元テーブル(pg_statistic)は内部管理用なので基本見ない。SUPERユーザーのみ参照可能。
    - ANALYZEコマンドで更新されるのは元テーブル(pg_statistic)。
    - pg_statsの`most_common_vals`,`most_common_freqs`を見て実行計画を決める！
  - サンプリングについて
    - 統計情報の収集はランダム・サンプリングを採用している。
    - サンプリング範囲は`default_statistics_target`パラメータで調整。大きいほど精度UP but ANALYZE時間が長くなる。
    - サンプリング範囲は**🔴カラムごとに🔴**設定可能👍
    - `CREATE TABLE`時は、すべてのカラムはDefaultで`100`。
    - その後、`ALTER TABLE`でカラムごとにサンプリング数を設定（`ALTER TABLE [テーブル名] ALTER [列名] SET STATISTICS 1000`）

## pg_statsの見方
✅`ANALYZE`実行されて、やっとこのテーブルに表示される。<br>
✅各カラムごとの統計情報を確認できる → これらが実行計画作成時に参照される！

### null_frac
- NULLの割合
  - `0` ⇒ NULL存在しない。
  - `0.05` ⇒ 5%のレコードがNULL。
- 🔴プランナーが「`WHERE col IS NULL`」で走査コストを見積もる時に使われる。<br>

### n_distinct
- 値のバリエーション
  - `2` ⇒ `gender`カラムに`MALE`or`FEMALE`みたいな
  - `500` ⇒ `price`カラムに500通りみたいな
  - `-0.5` ⇒ 総行数（1000件）× 0.5 = 500種類みたいな ★行数に比例して変動する👍
- 正の値の列は、固定カテゴリなので、将来新しい値が増えると推定がズレる（再ANALYZE必要）
- 負の値の列は、データが増えても統計が自動的に伸びるので安心
- 🔴`WHERE name = Bob`を検索するとき、`name`の`n_distinct`が`500` ⇒ プランナーは「1/500 ≈ 0.2%の行がヒット」と推定する。

### correlation
- ヒープ（テーブル本体）は基本的に挿入順に並んでいるが、それらがどの程度「順番」に並んでいるか。
- 👉相関性が高いとインデックススキャンが使われやすくなる。
<img width="500px" src="https://github.com/user-attachments/assets/9dd9be4f-e264-41db-b766-e2ef3eb9c067" />

- 大量にUPDATEするとcorrelationは0に近づいていく...どうすれば綺麗に並び直せる？
  - ✅`CLUSTER × 既存INDEX`コマンドで、検索によく使うカラム/INDEXで並び直す。
