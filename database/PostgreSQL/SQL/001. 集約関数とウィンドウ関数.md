## ウィンドウ＝検索結果の中でも特定の範囲(OVER句で範囲指定)
集約関数が対象レコードすべてに対して集約するのに対して、<br>
ウィンドウ関数は OVER句 で特定の範囲(ウィンドウ)でグループ分け(PARTITION BY)、並び替える(ORDER BY)、範囲指定(ROWS BETWEEN) を行った上でウィンドウ関数を適用する、であってますでしょうか？

<img width="700px" src="https://github.com/user-attachments/assets/24223c4c-e0b7-42f9-ab31-adf37f6343b3" />

## Window関数使う便利パターン
### OVER/Window作成条件 - 単体指定
#### 1. `ROW_NUMBER()`で連番を振る。
```sql
SELECT 
  ROW_NUMBER() OVER(ORDER BY Age ASC) AS 項番
  name AS 従業員名,
  Age AS 年齢
FROM employees;
```

#### 2. `RANK()`で順位をつける。
```sql
SELECT
  RANK() OVER (ORDER BY salary DESC) AS 給料順位
  name AS 氏名,
  salary AS 給料
FROM employees;
```

#### 3. `AVG()`で全体平均と比べる。
```sql
SELECT
    name AS 氏名,
    salary AS 給料,
    AVG(salary) OVER () AS 平均給与 -- ()であれば全行が１つのウィンドウとして扱われる。
FROM employees;
```

#### 4. `AVG()`で部署ごとの平均と比べる。
```sql
SELECT
    name AS 氏名,
    salary AS 給料,
    AVG(salary) OVER (PARTITION BY department_id) AS 平均給与 -- 部署ごとにウィンドウが作成される。
FROM employees;
```

### OVER/Window作成条件 - 複数指定

## 構文

```sql
SUM(amount)
OVER (
  PARTITION BY customer_id        -- グループ分け（例：顧客ごと）
  ORDER BY order_date             -- 並べ替え（例：日付順）
  ROWS BETWEEN 2 PRECEDING AND CURRENT ROW -- 範囲指定（例：直近3件）
)
```

## [例](https://www.postgresql.jp/docs/9.4/tutorial-window.html)
```sql
SELECT depname, empno, salary, avg(salary) OVER (PARTITION BY depname) FROM empsalary;
```
```
  depname  | empno | salary |          avg          
-----------+-------+--------+-----------------------
 develop   |    11 |   5200 | 5020.0000000000000000
 develop   |     7 |   4200 | 5020.0000000000000000
 develop   |     9 |   4500 | 5020.0000000000000000
 develop   |     8 |   6000 | 5020.0000000000000000
 develop   |    10 |   5200 | 5020.0000000000000000
 personnel |     5 |   3500 | 3700.0000000000000000
 personnel |     2 |   3900 | 3700.0000000000000000
 sales     |     3 |   4800 | 4866.6666666666666667
 sales     |     1 |   5000 | 4866.6666666666666667
 sales     |     4 |   4800 | 4866.6666666666666667
(10 rows)
```
