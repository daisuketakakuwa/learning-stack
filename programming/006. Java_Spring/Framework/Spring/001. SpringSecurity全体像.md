# Special Thanks

https://docs.spring.io/spring-security/reference/servlet/architecture.html

# 01. Filterã¯ã€Java Servletã®1æ©Ÿèƒ½
â†“ã®å›³ã¯Clientã‹ã‚‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ã¦ã‹ã‚‰Servletã§å‡¦ç†ã‚’å—ã‘ã‚‹å›³ã§ã‚ã‚‹ã€‚<br>
âœ…**Filterã¯"Servletã‚³ãƒ³ãƒ†ãƒŠ"ã«ç™»éŒ²ã™ã‚‹ã“ã¨ã§æœ‰åŠ¹ã¨ãªã‚‹ã€‚** <br>
ã€€â€»Springã®DIã‚³ãƒ³ãƒ†ãƒŠ(IoCã‚³ãƒ³ãƒ†ãƒŠ)ã¨ã¯åˆ¥ã€‚<br>
![](https://storage.googleapis.com/zenn-user-upload/6e61075e9d8d-20221029.png)

```java
// ä¾‹) å…¨ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã¦ãƒ­ã‚®ãƒ³ã‚°ã‚’å·®ã—è¾¼ã‚€
import javax.servlet.Filter;

public class LoggingFilter extends Filter {
    private static final Logger log = LoggerFactory.getLogger(LoggingFilter.class);

    @Override
    public void doFilter(
      ServletRequest request, 
      ServletResponse response,
      FilterChain chain) {
        chain.doFilter(request, response);
        HttpServletRequest httpServletRequest = (HttpServletRequest) request;
        
        String username = Optional
          .ofNullable(httpServletRequest.getAttribute("username"))
          .map(Object::toString)
          .orElse("guest");
        
        log.info(
          "Request from '{}@{}': {}?{}", 
          username, 
          request.getRemoteAddr(),
          httpServletRequest.getRequestURI(), 
          request.getParameterMap());
    }
}
```

# 02. Springã®Beanã‚’ã€Filterã¨ã—ã¦Servletã‚³ãƒ³ãƒ†ãƒŠã«ç™»éŒ²ã™ã‚‹
Servletå˜ä½“: Filterå®Ÿè£…ã‚¯ãƒ©ã‚¹ãŒServletã‚³ãƒ³ãƒ†ãƒŠã«ç™»éŒ²ã•ã‚Œã‚‹ã€‚<br>
SpringSecurity: **Filterå®Ÿè£…ã‚¯ãƒ©ã‚¹ã®"Bean"ã€Œã‚‚ã€Servletã‚³ãƒ³ãƒ†ãƒŠã«ç™»éŒ²ã•ã‚Œã‚‹ã€‚**

## âœ…Springã®Beanã‚’ã€Filterã¨ã—ã¦å®šç¾©ã™ã‚‹æ–¹æ³•
|Package|å†…å®¹|ç‰¹å¾´|
|----|----|----|
|spring-web|GenericFilterBean(Filter)ã‚’å®Ÿè£…ã—ãŸã‚¯ãƒ©ã‚¹ã‚’Beanç™»éŒ²ã™ã‚‹ã€‚|ã€‡Filterã‚’æ–°è¦ä½œæˆã™ã‚‹ã€‚|
|spring-boot|FilterRegistrationBeanã‚’newã—ã¦Beanç™»éŒ²ã™ã‚‹ã€‚|â—åˆ¥é€”ä½œæˆæ¸ˆã®Filterã‚¯ãƒ©ã‚¹ã‚’ã€URLãƒ‘ã‚¿ãƒ¼ãƒ³ã€‘ã€Orderã€‘ã¨å…±ã«ç™»éŒ²ã§ãã‚‹ã€‚|
|spring-security|HttpSecurityçµŒç”±ã§SecurityFilterChainã®1Filterã¨ã—ã¦å·®ã—è¾¼ã‚€ã€‚|â˜…HttpSecurityã®ãƒ¡ã‚½ãƒƒãƒ‰ã§å·®ã—è¾¼ã‚ã‚‹ã‚„ã¤ã¯ã“ã‚ŒãŒã„ã„ğŸ‘<br/>ä¾‹) http.formLogin() = UsernamePasswordAuthenticationFilterã‚’å·®ã—è¾¼ã‚ã‚‹ã€‚|

## 1. GenericFilterBean(â‰’javax.servlet.Filter)ã€Filterå®šç¾©ã€‘
âœ…Beanç™»éŒ²ã•ã‚ŒãŸFilterå®Ÿè£…ã‚¯ãƒ©ã‚¹ã‚’ã€DelegatingFilterProxyãŒServletã‚³ãƒ³ãƒ†ãƒŠã«Filterã¨ã—ã¦ç™»éŒ²ã—ã¦ãã‚Œã‚‹ã€‚<br>
âœ…**FilterRegistrationBean.addUrlPatterns()ç­‰ã‚’ä½¿ã‚ãªã‘ã‚Œã°**ã€å…¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®å¯¾è±¡ã¨ãªã‚‹ã€‚
```java
// JwtTokenFilterã€å…¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã¦JWTæŠœãå‡ºã—å‡¦ç†ã‚’é©ç”¨ã—ã¦ã‚‹ã€‘
import org.springframework.web.filter.GenericFilterBean;

@Component
public class JwtTokenFilter extends GenericFilterBean {

  @Autowired JwtTokenProvider jwtTokenProvider;

  @Override
  public void doFilter(ServletRequest req, ServletResponse res, FilterChain filterChain)
      throws IOException, ServletException {

    String token = jwtTokenProvider.resolveToken((HttpServletRequest) req);
    if (token != null && jwtTokenProvider.validateToken(token)) {
      Authentication auth = jwtTokenProvider.buildAuthentication(token);
      // âœ…TokenãŒå­˜åœ¨ã™ã‚‹ï¼setAuthentication()ã§èªè¨¼æ¸ˆã¨ãªã‚‹ã€‚
      SecurityContextHolder.getContext().setAuthentication(auth);
    }
    
    filterChain.doFilter(req, res);
  }
}
```

## 2. FilterRegistrationBeanã€URLãƒ‘ã‚¿ãƒ¼ãƒ³/Orderä»˜ã§Filterç™»éŒ²ã€‘
âœ…ã€ŒGenericFilterBeanã§å®šç¾©ã—ãŸFilterã‚’ç‰¹å®šã®URLã ã‘ã«é™å®šã—ãŸã„ï¼ã€ã£ã¦æ™‚ã«ä½¿ã†ã€‚
```java: /apis/**ã«å¯¾ã—ã¦ã®ã¿ã€å…ˆã»ã©ã®JwtTokenFilterã‚’é©ç”¨ã™ã‚‹ã€‚
@Configuration
public class FilterConfig {
 
 @Bean
  public FilterRegistrationBean demoFilter1(){
      FilterRegistrationBean bean = new FilterRegistrationBean(new JwtTokenFilter());
      bean.addUrlPatterns("/apis/**");
      bean.setOrder(1);
      return bean;
  }
```

## 3. HttpSecurityçµŒç”±ã§SecurityFilterChainå†…ã®1Filterã¨ã—ã¦å·®ã—è¾¼ã‚€ã€‚
âœ…HttpSecurityã‚¯ãƒ©ã‚¹ã§DefaultSecurityFilterChainã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹éç¨‹ã§ã€HttpSecurityãŒæä¾›ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§â†“ã®ã‚ˆã†ã«ç°¡å˜ã«Filterã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        
        http
	  .formLogin() // UsernamePasswordAuthenticationFilterè¿½åŠ 
          .httpBasic() // BasicAuthenticationFilterè¿½åŠ 
	  .csrf();     // CsrfFilterè¿½åŠ 
	// build()ã§ã€Oã®DefaultSecurityFilterChainãŒç”Ÿæˆã•ã‚Œã‚‹ã€‚
	return http.build();
```

# 03. Springã®Beanã‚’ã€Filterã¨ã—ã¦Servletã‚³ãƒ³ãƒ†ãƒŠã®Filterã¨ã—ã¦ç™»éŒ²ã§ãã‚‹ä»•çµ„ã¿

|ç™»å ´äººç‰©|WHO|ä½•ã™ã‚‹ã®|
|----|----|----|
|DelegatingFilterProxy|Class|Filterå®Ÿè£…ã‚¯ãƒ©ã‚¹ã®Beanã‚’æ¤œçŸ¥ã—ã€Servletã‚³ãƒ³ãƒ†ãƒŠã«ç™»éŒ²ã™ã‚‹ã€‚ã“ã„ã¤ã‚‚1ã¤ã®Filterã€‚|
|FilterChainProxy|Class|ã“ã„ã¤ã‚‚1ã¤ã®Filterã€‚`List<SecurityFilterChain>`ã§è¤‡æ•°ã®SecurityFilterChainã¨ç¹‹ãŒã£ã¦ã„ã‚‹ã€‚|
|SecurityFilterChain|IF|`boolean matches(request)`ã¨`List<Filter>`ãŒIFã€‚<br/>`matches()`ã§åˆè‡´ã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã¦`List<Filter>`ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’é©ç”¨ã€‚|
|DefaultSecrityFilterChain|Class|SecurityFilterChainã®å®Ÿè£…ã‚¯ãƒ©ã‚¹ã€‚|
|HttpSecurity|Class|DefaultSecrityFilterChainã®ãƒ“ãƒ«ãƒ€ãƒ¼ã‚¯ãƒ©ã‚¹ã€‚<br/>âœ…**é–‹ç™ºè€…ã¯ã“ã“ã«è‰²ã€…å®šç¾©ã—ã¦ã„ãã€‚**|

![](https://storage.googleapis.com/zenn-user-upload/023a8d4a4b32-20221029.png)

# 04. UsernamePasswordAuthenticationFilterã§DBã¾ã§æ¤œç´¢ã—ã«ã„ãæµã‚Œ
![](https://storage.googleapis.com/zenn-user-upload/70ca469495ee-20221029.png)


# 05. spring-boot-starter-securityã‚’IMPORTã™ã‚‹ã¨ã€DefaultSecurityFilterChainã‚’ä½œã£ã¦ãã‚Œã‚‹ä»¶ã€‚[å‚è€ƒ](https://docs.spring.io/spring-security/reference/servlet/getting-started.html#servlet-hello-auto-configuration)
`spring-boot-starter-security`ã‚’ä¾å­˜é–¢ä¿‚ã«è¿½åŠ ã™ã‚‹ã¨ã€ä¸‹è¨˜2ã¤ã®ã‚¯ãƒ©ã‚¹ãŒIMPORTã•ã‚Œã‚‹ã€‚
â‘ [SpringBootWebSecurityConfiguration.java](https://github.com/spring-projects/spring-boot/blob/main/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/security/servlet/SpringBootWebSecurityConfiguration.java)
â‘¡[AuthenticationManagerConfiguration.java](https://github.com/joansmith/spring-boot/blob/master/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/security/AuthenticationManagerConfiguration.java)
IMPORTã—ãŸã‚¯ãƒ©ã‚¹ã®ä¸­ã«ä¸‹è¨˜ã®Beanå®šç¾©ãŒå­˜åœ¨ã—ã€ã“ã“ã§HttpSecurityã‚’åˆ©ç”¨ã—ãŸDefaultSecurityFilterChainã®ãƒ“ãƒ«ãƒ‰ã‚’è¡Œã£ã¦ãã‚Œã‚‹ã¨ã„ã†ã‚ã‘ã ã€‚
```java
// SpringBootWebSecurityConfiguration.java L57-L66
@Bean
@Order(SecurityProperties.BASIC_AUTH_ORDER)
SecurityFilterChain defaultSecurityFilterChain(HttpSecurity http) throws Exception {
	http.authorizeHttpRequests().anyRequest().authenticated();
	http.formLogin();
	http.httpBasic();
	http.setSharedObject(SecurityContextRepository.class, new DelegatingSecurityContextRepository(
			new RequestAttributeSecurityContextRepository(), new HttpSessionSecurityContextRepository()));
	return http.build();
}
```

# 06. HttpSecurityã¨AuthenticationManagerBuilderã¯åŒã˜IF(SecurityBuilder)ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã€‚
âœ…HttpSecurityã¯ã€`SecurityBuilder<DefaultSecurityFilterChain>`<br>
âœ…HttpSecurityã¯ã€`SecurityBuilder<DefaultSecurityFilterChain>`<br>
âœ…HttpSecurityã¯ã€`SecurityBuilder<DefaultSecurityFilterChain>`<br>
	
âœ…AuthenticationManagerBuilderã¯ã€`SecurityBuilder<AuthenticationManager>`<br>
âœ…AuthenticationManagerBuilderã¯ã€`SecurityBuilder<AuthenticationManager>`<br>
âœ…AuthenticationManagerBuilderã¯ã€`SecurityBuilder<AuthenticationManager>`<br>

å¤§äº‹ãªã“ã¨ãªã®ã§ï¼“å›ãšã¤æ›¸ãã¾ã—ãŸã€‚é‡è¦ãªç™»å ´äººç‰©ã§ã‚ã‚‹ã€ŒDefaultSecurityFilterChainã€ã¨ã€ŒAuthenticationManagerã€ã¯ã€`SecurityBuilder`ã¨ã„ã†å…±é€šIFã«æ²¿ã£ã¦ãƒ“ãƒ«ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã€‚

![](https://storage.googleapis.com/zenn-user-upload/441f8eba87ca-20221029.png)
	
# è‡ªåˆ†ç”¨ãƒ¡ãƒ¢

## è‡ªåˆ†ç”¨ãƒ¡ãƒ¢1: AuthenticationFilter(ã‚¯ãƒ©ã‚¹)  = AbstractAuthenticationProcessingFilter(Abã‚¯ãƒ©ã‚¹) + Î±
ä¸¡æ–¹ã¨ã‚‚`authenticationManager.authenticate()`ã‚’ã‚³ãƒ¼ãƒ«ã—ã¦ã„ã‚‹Filterã‚¯ãƒ©ã‚¹ã€‚
```
Authenticationã‚¯ãƒ©ã‚¹å˜ä½“ ã§ä½¿ãˆã‚‹
```
ã®ã¨
```
AbstractAuthenticationProcessingFilter(Abã‚¯ãƒ©ã‚¹)
ã€€+
Î±ã€UsernamePasswordAuthenticationFilter(ã‚¯ãƒ©ã‚¹)ã€‘
```
ã¨ã„ã†æ„Ÿã˜ã€‚
 

## è‡ªåˆ†ç”¨ãƒ¡ãƒ¢2: HttpSecurityè¨­å®šä¾‹1(antMatchersã§URLã”ã¨ã«è¦æ±‚ROLEã‚’å®šç¾©)
```java
http
  .csrf().disable()
  .authorizeRequests()
  .antMatchers(HttpMethod.DELETE, "/api/v1/products/{productId}").hasRole(ADMIN.name()) // Admin should be able to delete
  .antMatchers(HttpMethod.PUT, "/api/v1/products/{productId}").hasRole(ADMIN.name()) // Admin should be able to update
  .antMatchers("/api/v1/products/add").hasAnyRole(ADMIN.name(), SUPERVISOR.name()) // Admin and Supervisor should be able to add product.
  .antMatchers("/api/v1/products").hasAnyRole(ADMIN.name(), SUPERVISOR.name(), INTERN.name()) // All three users should be able to get all products.
  .antMatchers("/api/v1/products{productId}").hasAnyRole(ADMIN.name(), SUPERVISOR.name(), INTERN.name()) // All three users should be able to get a product by id.
  .anyRequest()
  .authenticated()
  .and()
  .httpBasic();
```


# QUESTION
## Q1. Filterã‚’Beanã§å®šç¾©ã§ãã‚‹ã¨ä½•ãŒã„ã„ï¼Ÿãã®é€†ã¯ï¼Ÿ


